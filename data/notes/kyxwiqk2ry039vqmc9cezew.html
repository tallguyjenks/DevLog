<h1 id="datawarehouse-calendar-table"><a aria-hidden="true" class="anchor-heading icon-link" href="#datawarehouse-calendar-table"></a>Datawarehouse Calendar Table</h1>
<h2 id="date-dimension-table"><a aria-hidden="true" class="anchor-heading icon-link" href="#date-dimension-table"></a>Date Dimension Table</h2>
<pre class="language-sql"><code class="language-sql"><span class="token comment">/**************************************************************************************************************************\
|===========================================================================================================================|
|                                                                                                                           |
|                                                                                                                           |
| Reference Article: https://www.mssqltips.com/sqlservertip/4054/creating-a-date-dimension-or-calendar-table-in-sql-server/ |
|                                                                                                                           |
|                                                                                                                           |
|===========================================================================================================================|
***************************************************************************************************************************/</span>

<span class="token comment">-- FIXME Change all instances of `Ticketer` to the database chosen to house these DBO's</span>
<span class="token keyword">USE</span> Ticketer

<span class="token keyword">IF</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">'Ticketer.dbo.HolidayDimension'</span><span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> HolidayDimension
<span class="token keyword">IF</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">'Ticketer.dbo.DateDimension'</span><span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> DateDimension
<span class="token keyword">IF</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">'Ticketer.dbo.TheCalendar'</span><span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> TheCalendar

<span class="token comment">-- prevent set or regional settings from interfering with</span>
<span class="token comment">-- interpretation of dates / literals</span>
<span class="token keyword">SET</span> DATEFIRST  <span class="token number">7</span> <span class="token comment">-- 1 = Monday, 7 = Sunday</span>
    <span class="token punctuation">,</span> DATEFORMAT mdy
    <span class="token punctuation">,</span> <span class="token keyword">LANGUAGE</span>   US_ENGLISH<span class="token punctuation">;</span>

<span class="token comment">-- Start and End points</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@StartDate</span>  <span class="token keyword">DATE</span> <span class="token operator">=</span> <span class="token string">'20100101'</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@CutoffDate</span> <span class="token keyword">DATE</span> <span class="token operator">=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token variable">@StartDate</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- First CTE generating the list of numbers from the Start and End points</span>
<span class="token punctuation">;</span><span class="token keyword">WITH</span> seq<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">AS</span>
<span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token number">0</span> <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span> n <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">FROM</span> seq
	<span class="token keyword">WHERE</span> n <span class="token operator">&#x3C;</span> DATEDIFF<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> <span class="token variable">@StartDate</span><span class="token punctuation">,</span> <span class="token variable">@CutoffDate</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
d<span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token keyword">AS</span>
<span class="token punctuation">(</span> <span class="token comment">-- Second CTE generating an ISO 8601 Date from the numbers</span>
	<span class="token keyword">SELECT</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token variable">@StartDate</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> seq
<span class="token punctuation">)</span><span class="token punctuation">,</span>
src <span class="token keyword">AS</span>
<span class="token punctuation">(</span> <span class="token comment">-- Third CTE taking the generated dates and parsing them into the pertinent information</span>
	<span class="token keyword">SELECT</span>
		  TheDate         <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">DATE</span><span class="token punctuation">,</span>		d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheDay          <span class="token operator">=</span> DATEPART<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span>       d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheDayName      <span class="token operator">=</span> DATENAME<span class="token punctuation">(</span>WEEKDAY<span class="token punctuation">,</span>   d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheWeek         <span class="token operator">=</span> DATEPART<span class="token punctuation">(</span>WEEK<span class="token punctuation">,</span>      d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheISOWeek      <span class="token operator">=</span> DATEPART<span class="token punctuation">(</span>ISO_WEEK<span class="token punctuation">,</span>  d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheDayOfWeek    <span class="token operator">=</span> DATEPART<span class="token punctuation">(</span>WEEKDAY<span class="token punctuation">,</span>   d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheMonth        <span class="token operator">=</span> DATEPART<span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">,</span>     d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheMonthName    <span class="token operator">=</span> DATENAME<span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">,</span>     d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheQuarter      <span class="token operator">=</span> DATEPART<span class="token punctuation">(</span>Quarter<span class="token punctuation">,</span>   d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheYear         <span class="token operator">=</span> DATEPART<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span>      d<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheFirstOfMonth <span class="token operator">=</span> DATEFROMPARTS<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">MONTH</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheLastOfYear   <span class="token operator">=</span> DATEFROMPARTS<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheDayOfYear    <span class="token operator">=</span> DATEPART<span class="token punctuation">(</span>DAYOFYEAR<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
	<span class="token keyword">FROM</span> d
<span class="token punctuation">)</span><span class="token punctuation">,</span>
dim <span class="token keyword">AS</span>
<span class="token punctuation">(</span> <span class="token comment">-- Fourth CTE adding additional information of value</span>
	<span class="token keyword">SELECT</span>
		  TheDate
		<span class="token punctuation">,</span> TheDay
		<span class="token punctuation">,</span> TheDaySuffix       <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">CASE</span>
												<span class="token keyword">WHEN</span> TheDay <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'th'</span>
												<span class="token keyword">ELSE</span> 
													<span class="token keyword">CASE</span> <span class="token keyword">RIGHT</span><span class="token punctuation">(</span>TheDay<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
														<span class="token keyword">WHEN</span> <span class="token string">'1'</span> <span class="token keyword">THEN</span> <span class="token string">'st'</span>
														<span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> <span class="token string">'nd'</span>
														<span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> <span class="token string">'rd'</span>
														<span class="token keyword">ELSE</span> <span class="token string">'th'</span> <span class="token keyword">END</span>
												<span class="token keyword">END</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheDayName
		<span class="token punctuation">,</span> TheDayOfWeek
		<span class="token punctuation">,</span> TheDayOfWeekInMonth <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">TINYINT</span><span class="token punctuation">,</span> ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> TheFirstOfMonth<span class="token punctuation">,</span> TheDayOfWeek <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> TheDate<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheDayOfYear
		<span class="token punctuation">,</span> IsWeekend           <span class="token operator">=</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> TheDayOfWeek <span class="token operator">IN</span> <span class="token punctuation">(</span>
									<span class="token keyword">CASE</span> @<span class="token variable">@DATEFIRST</span>
									<span class="token keyword">WHEN</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token number">6</span>
									<span class="token keyword">WHEN</span> <span class="token number">7</span> <span class="token keyword">THEN</span> <span class="token number">1</span>
									<span class="token keyword">END</span><span class="token punctuation">,</span> <span class="token number">7</span>
								<span class="token punctuation">)</span> 
								<span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span>
		<span class="token punctuation">,</span> TheWeek
		<span class="token punctuation">,</span> TheISOweek
		<span class="token punctuation">,</span> TheFirstOfWeek      <span class="token operator">=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> TheDayOfWeek<span class="token punctuation">,</span> TheDate<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheLastOfWeek       <span class="token operator">=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> TheDayOfWeek<span class="token punctuation">,</span> TheDate<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheWeekOfMonth      <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">TINYINT</span><span class="token punctuation">,</span> DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> TheYear<span class="token punctuation">,</span> TheMonth <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> TheWeek<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheMonth
		<span class="token punctuation">,</span> TheMonthName
		<span class="token punctuation">,</span> TheFirstOfMonth
		<span class="token punctuation">,</span> TheLastOfMonth      <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>TheDate<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> TheYear<span class="token punctuation">,</span> TheMonth<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheFirstOfNextMonth <span class="token operator">=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> TheFirstOfMonth<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheLastOfNextMonth  <span class="token operator">=</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">MONTH</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> TheFirstOfMonth<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheQuarter
		<span class="token punctuation">,</span> TheFirstOfQuarter   <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>TheDate<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> TheYear<span class="token punctuation">,</span> TheQuarter<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheLastOfQuarter    <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>TheDate<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> TheYear<span class="token punctuation">,</span> TheQuarter<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheYear
		<span class="token punctuation">,</span> TheISOYear          <span class="token operator">=</span> TheYear <span class="token operator">-</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> TheMonth <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> TheISOWeek <span class="token operator">></span> <span class="token number">51</span> <span class="token keyword">THEN</span> <span class="token number">1</span>
											   <span class="token keyword">WHEN</span> TheMonth <span class="token operator">=</span> <span class="token number">12</span> <span class="token operator">AND</span> TheISOWeek <span class="token operator">=</span> <span class="token number">1</span>  <span class="token keyword">THEN</span> <span class="token operator">-</span><span class="token number">1</span>
											   <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span>
		<span class="token punctuation">,</span> TheFirstOfYear      <span class="token operator">=</span> DATEFROMPARTS<span class="token punctuation">(</span>TheYear<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> TheLastOfYear
		<span class="token punctuation">,</span> IsLeapYear          <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">BIT</span><span class="token punctuation">,</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> TheYear <span class="token operator">%</span> <span class="token number">400</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">OR</span> <span class="token punctuation">(</span>TheYear <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">AND</span> TheYear <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">&#x3C;></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> Has53Weeks          <span class="token operator">=</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> DATEPART<span class="token punctuation">(</span>WEEK<span class="token punctuation">,</span> TheLastOfYear<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">53</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span>
		<span class="token punctuation">,</span> Has53ISOWeeks       <span class="token operator">=</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> DATEPART<span class="token punctuation">(</span>ISO_WEEK<span class="token punctuation">,</span> TheLastOfYear<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">53</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span>
		<span class="token punctuation">,</span> YYYYMM			  <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>TheYear<span class="token punctuation">,</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token function">LEN</span><span class="token punctuation">(</span>TheMonth<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span> TheMonth<span class="token punctuation">)</span> <span class="token keyword">ELSE</span> TheMonth <span class="token keyword">END</span><span class="token punctuation">)</span> 
		<span class="token punctuation">,</span> MMYYYY              <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TheDate<span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TheYear<span class="token punctuation">)</span>
		<span class="token punctuation">,</span> Style101            <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TheDate<span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> Style103            <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TheDate<span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> Style112            <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  TheDate<span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">)</span>
		<span class="token punctuation">,</span> Style120            <span class="token operator">=</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TheDate<span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span>
	<span class="token keyword">FROM</span> src
<span class="token punctuation">)</span>
<span class="token comment">-- CREATE THE DATE DIMENSION TABLE</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">INTO</span> dbo<span class="token punctuation">.</span>DateDimension
<span class="token keyword">FROM</span> dim
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> TheDate
<span class="token keyword">OPTION</span> <span class="token punctuation">(</span>MAXRECURSION <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">CLUSTERED</span> <span class="token keyword">INDEX</span> CIX_DateDimension <span class="token keyword">ON</span> dbo<span class="token punctuation">.</span>DateDimension<span class="token punctuation">(</span>TheDate<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- CREATE THE HOLIDAY DIMENSION TABLE</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dbo<span class="token punctuation">.</span>HolidayDimension
<span class="token punctuation">(</span>
	TheDate <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	HolidayText NVARCHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token keyword">CONSTRAINT</span> FK_DateDimension <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>TheDate<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> dbo<span class="token punctuation">.</span>DateDimension<span class="token punctuation">(</span>TheDate<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">CLUSTERED</span> <span class="token keyword">INDEX</span> CIX_HolidayDimension <span class="token keyword">ON</span> dbo<span class="token punctuation">.</span>HolidayDimension<span class="token punctuation">(</span>TheDate<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">;</span><span class="token keyword">WITH</span> x <span class="token keyword">AS</span>
<span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span>
		  TheDate
		<span class="token punctuation">,</span> TheFirstOfYear
		<span class="token punctuation">,</span> TheDayOfWeekInMonth
		<span class="token punctuation">,</span> TheMonth
		<span class="token punctuation">,</span> TheDayName
		<span class="token punctuation">,</span> TheDay
		<span class="token punctuation">,</span> TheLastDayOfWeekInMonth <span class="token operator">=</span> ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span>
		  <span class="token punctuation">(</span>
			<span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> TheFirstOfMonth<span class="token punctuation">,</span> TheDayOfWeek
			<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> TheDate <span class="token keyword">DESC</span>
		  <span class="token punctuation">)</span>
	<span class="token keyword">FROM</span> dbo<span class="token punctuation">.</span>DateDimension
<span class="token punctuation">)</span><span class="token punctuation">,</span>
s <span class="token keyword">AS</span>
<span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span>
		  TheDate
		<span class="token punctuation">,</span> HolidayText <span class="token operator">=</span> <span class="token keyword">CASE</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheDate <span class="token operator">=</span> TheFirstOfYear<span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'New Year''s Day'</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Monday'</span><span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'Martin Luther King Day'</span>		<span class="token comment">-- (3rd Monday in January)</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Monday'</span><span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'President''s Day'</span>				<span class="token comment">-- (3rd Monday in February)</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheMonth <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">AND</span> TheDay <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'Cesar Chavez Day'</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheLastDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Monday'</span><span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'Memorial Day'</span>					<span class="token comment">-- (last Monday in May)</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheMonth <span class="token operator">=</span> <span class="token number">7</span> <span class="token operator">AND</span> TheDay <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'Independence Day'</span>				<span class="token comment">-- (July 4th)</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">9</span> <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Monday'</span><span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'Labour Day'</span>					<span class="token comment">-- (first Monday in September)</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheMonth <span class="token operator">=</span> <span class="token number">11</span> <span class="token operator">AND</span> TheDay <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'Veterans'' Day'</span>				<span class="token comment">-- (November 11th)</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">11</span> <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Thursday'</span><span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'Thanksgiving Day'</span>             <span class="token comment">-- (Thanksgiving Day ()fourth Thursday in November)</span>
		<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>TheMonth <span class="token operator">=</span> <span class="token number">12</span> <span class="token operator">AND</span> TheDay <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">)</span>
			<span class="token keyword">THEN</span> <span class="token string">'Christmas Day'</span>
		<span class="token keyword">END</span>
	<span class="token keyword">FROM</span> x
	<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>TheDate <span class="token operator">=</span> TheFirstOfYear<span class="token punctuation">)</span>													<span class="token comment">-- New Years</span>
		<span class="token operator">OR</span> <span class="token punctuation">(</span>TheDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">3</span>     <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">1</span>  <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Monday'</span><span class="token punctuation">)</span>	<span class="token comment">-- MLK Day</span>
		<span class="token operator">OR</span> <span class="token punctuation">(</span>TheDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">3</span>     <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">2</span>  <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Monday'</span><span class="token punctuation">)</span>	<span class="token comment">-- Presidents Day</span>
		<span class="token operator">OR</span> <span class="token punctuation">(</span>TheMonth <span class="token operator">=</span> <span class="token number">3</span>				<span class="token operator">AND</span> TheDay <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">)</span>								<span class="token comment">-- Cesar Chavez Day</span>
		<span class="token operator">OR</span> <span class="token punctuation">(</span>TheLastDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">5</span>  <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Monday'</span><span class="token punctuation">)</span>	<span class="token comment">-- Memorial Day</span>
		<span class="token operator">OR</span> <span class="token punctuation">(</span>TheMonth <span class="token operator">=</span> <span class="token number">7</span>				<span class="token operator">AND</span> TheDay <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span>									<span class="token comment">-- Independence Day</span>
		<span class="token operator">OR</span> <span class="token punctuation">(</span>TheDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">1</span>     <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">9</span>  <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Monday'</span><span class="token punctuation">)</span>	<span class="token comment">-- Labor Day</span>
		<span class="token operator">OR</span> <span class="token punctuation">(</span>TheMonth <span class="token operator">=</span> <span class="token number">11</span>				<span class="token operator">AND</span> TheDay <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">)</span>								<span class="token comment">-- Veterans Day</span>
		<span class="token operator">OR</span> <span class="token punctuation">(</span>TheDayOfWeekInMonth <span class="token operator">=</span> <span class="token number">4</span>     <span class="token operator">AND</span> TheMonth <span class="token operator">=</span> <span class="token number">11</span> <span class="token operator">AND</span> TheDayName <span class="token operator">=</span> <span class="token string">'Thursday'</span><span class="token punctuation">)</span>	<span class="token comment">-- Thanksgiving Day</span>
		<span class="token operator">OR</span> <span class="token punctuation">(</span>TheMonth <span class="token operator">=</span> <span class="token number">12</span>				<span class="token operator">AND</span> TheDay <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">)</span>								<span class="token comment">-- Christmas Day</span>
<span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> dbo<span class="token punctuation">.</span>HolidayDimension<span class="token punctuation">(</span>TheDate<span class="token punctuation">,</span> HolidayText<span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> TheDate<span class="token punctuation">,</span> HolidayText <span class="token keyword">FROM</span> s
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
<span class="token keyword">SELECT</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> TheDate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Black Friday'</span> <span class="token comment">-- Special Case</span>
<span class="token keyword">FROM</span> s <span class="token keyword">WHERE</span> HolidayText <span class="token operator">=</span> <span class="token string">'Thanksgiving Day'</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> TheDate<span class="token punctuation">;</span>
GO

<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> dbo<span class="token punctuation">.</span>TheCalendar
<span class="token keyword">AS</span>
	<span class="token keyword">SELECT</span>
		  d<span class="token punctuation">.</span><span class="token operator">*</span>
		<span class="token punctuation">,</span> IsHoliday <span class="token operator">=</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> h<span class="token punctuation">.</span>TheDate <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span>
		<span class="token punctuation">,</span> h<span class="token punctuation">.</span>HolidayText
	<span class="token keyword">FROM</span> dbo<span class="token punctuation">.</span>DateDimension <span class="token keyword">AS</span> d
		<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> dbo<span class="token punctuation">.</span>HolidayDimension <span class="token keyword">AS</span> h
			<span class="token keyword">ON</span> d<span class="token punctuation">.</span>TheDate <span class="token operator">=</span> h<span class="token punctuation">.</span>TheDate<span class="token punctuation">;</span>
</code></pre>