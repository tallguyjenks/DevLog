<h1 id="retry"><a aria-hidden="true" class="anchor-heading icon-link" href="#retry"></a>Retry</h1>
<p><a href="https://calmcode.io/shorts/retry.py.html">https://calmcode.io/shorts/retry.py.html</a></p>
<p>Related to <a href="/DevLog/notes/s3z841ezl7wxwc8pmv7bmzz">Fastapi</a></p>
<blockquote>
<p>The retry library has a single decorator that can tell the function to try again after failing. Here's how you can use it:</p>
</blockquote>
<h2 id="setup"><a aria-hidden="true" class="anchor-heading icon-link" href="#setup"></a>Setup</h2>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> random
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> HTTPError

<span class="token keyword">def</span> <span class="token function">pretend_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0.01</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPError<span class="token punctuation">(</span><span class="token string">"Something went wrong!"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"alive"</span><span class="token punctuation">}</span>

<span class="token comment"># You'll likely hit an error</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pretend_request<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="usage"><a aria-hidden="true" class="anchor-heading icon-link" href="#usage"></a>Usage</h2>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> retry <span class="token keyword">import</span> retry

<span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>tries<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> delay<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pretend_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0.01</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPError<span class="token punctuation">(</span><span class="token string">"Something went wrong!"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"alive"</span><span class="token punctuation">}</span>

<span class="token comment"># You'll likely hit an error</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pretend_request<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="put-it-all-toether"><a aria-hidden="true" class="anchor-heading icon-link" href="#put-it-all-toether"></a>Put it all toether</h2>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> random
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> HTTPError
<span class="token keyword">from</span> retry <span class="token keyword">import</span> retry

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>HTTPError<span class="token punctuation">,</span> tries<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> delay<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> backoff<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pretend_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0.1</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> rq<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>HTTPError<span class="token punctuation">(</span><span class="token string">"Something went wrong!"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"alive"</span><span class="token punctuation">}</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pretend_request<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># >>> WARNING:retry.api:Something went wrong!, retrying in 0.1 seconds...</span>
<span class="token comment"># >>> WARNING:retry.api:Something went wrong!, retrying in 0.2 seconds...</span>
<span class="token comment"># >>> WARNING:retry.api:Something went wrong!, retrying in 0.4 seconds...</span>
</code></pre>
<h2 id="configuration"><a aria-hidden="true" class="anchor-heading icon-link" href="#configuration"></a>Configuration</h2>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> random
<span class="token keyword">from</span> retry <span class="token keyword">import</span> retry
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> HTTPError


<span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>HTTPError<span class="token punctuation">,</span> tries<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> delay<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pretend_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0.01</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPError<span class="token punctuation">(</span><span class="token string">"Something went wrong!"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"alive"</span><span class="token punctuation">}</span>

<span class="token comment"># Now, the function will only retry if detects a HTTPError. If you were to configure it to only respond to ValueError and TypeError then any other errors will be ignored.</span>

<span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ValueError<span class="token punctuation">,</span> TypeError<span class="token punctuation">)</span><span class="token punctuation">,</span> tries<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> delay<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pretend_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0.01</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPError<span class="token punctuation">(</span><span class="token string">"Something went wrong!"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"alive"</span><span class="token punctuation">}</span>

<span class="token comment"># You'll likely hit an error again</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pretend_request<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>