<h1 id="sql-server-script-to-rebuild-all-indexes-for-all-tables-and-all-databases"><a aria-hidden="true" class="anchor-heading icon-link" href="#sql-server-script-to-rebuild-all-indexes-for-all-tables-and-all-databases"></a>Sql Server Script to Rebuild All Indexes for All Tables and All Databases</h1>
<p></p><p></p><div class="portal-container">
<div class="portal-head">
<div class="portal-backlink">
<div class="portal-title">From <span class="portal-text-title">Sql Server Script to Rebuild All Indexes for All Tables and All Databases</span></div>
<a href="/DevLog/notes/55vb6fb0ht51hvnw7wi588k" class="portal-arrow">Go to text <span class="right-arrow">â†’</span></a>
</div>
</div>
<div id="portal-parent-anchor" class="portal-parent" markdown="1">
<div class="portal-parent-fader-top"></div>
<div class="portal-parent-fader-bottom"></div><h2 id="rebuild-all-indexes-script-for-sql-server-2005-and-later"><a aria-hidden="true" class="anchor-heading icon-link" href="#rebuild-all-indexes-script-for-sql-server-2005-and-later"></a>Rebuild All Indexes Script for SQL Server 2005 and Later</h2>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">DECLARE</span> <span class="token variable">@Database</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@Table</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@cmd</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token keyword">DECLARE</span> DatabaseCursor <span class="token keyword">CURSOR</span> READ_ONLY <span class="token keyword">FOR</span>
<span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> master<span class="token punctuation">.</span>sys<span class="token punctuation">.</span><span class="token keyword">databases</span>
<span class="token keyword">WHERE</span> name <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'master'</span><span class="token punctuation">,</span><span class="token string">'msdb'</span><span class="token punctuation">,</span><span class="token string">'tempdb'</span><span class="token punctuation">,</span><span class="token string">'model'</span><span class="token punctuation">,</span><span class="token string">'distribution'</span><span class="token punctuation">)</span>  <span class="token comment">-- databases to exclude</span>
<span class="token comment">--WHERE name IN ('DB1', 'DB2') -- use this to select specific databases and comment out line above</span>
<span class="token operator">AND</span> state <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">-- database is online</span>
<span class="token operator">AND</span> is_in_standby <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">-- database is not read only for log shipping</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">1</span>

<span class="token keyword">OPEN</span> DatabaseCursor

<span class="token keyword">FETCH</span> <span class="token keyword">NEXT</span> <span class="token keyword">FROM</span> DatabaseCursor <span class="token keyword">INTO</span> <span class="token variable">@Database</span>
<span class="token keyword">WHILE</span> @<span class="token variable">@FETCH_STATUS</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">BEGIN</span>

   <span class="token keyword">SET</span> <span class="token variable">@cmd</span> <span class="token operator">=</span> <span class="token string">'DECLARE TableCursor CURSOR READ_ONLY FOR SELECT ''['' + table_catalog + ''].['' + table_schema + ''].['' +
   table_name + '']'' as tableName FROM ['</span> <span class="token operator">+</span> <span class="token variable">@Database</span> <span class="token operator">+</span> <span class="token string">'].INFORMATION_SCHEMA.TABLES WHERE table_type = ''BASE TABLE'''</span>

   <span class="token comment">-- create table cursor</span>
   <span class="token keyword">EXEC</span> <span class="token punctuation">(</span><span class="token variable">@cmd</span><span class="token punctuation">)</span>
   <span class="token keyword">OPEN</span> TableCursor

   <span class="token keyword">FETCH</span> <span class="token keyword">NEXT</span> <span class="token keyword">FROM</span> TableCursor <span class="token keyword">INTO</span> <span class="token variable">@Table</span>
   <span class="token keyword">WHILE</span> @<span class="token variable">@FETCH_STATUS</span> <span class="token operator">=</span> <span class="token number">0</span>
   <span class="token keyword">BEGIN</span>
      <span class="token keyword">BEGIN</span> TRY
         <span class="token keyword">SET</span> <span class="token variable">@cmd</span> <span class="token operator">=</span> <span class="token string">'ALTER INDEX ALL ON '</span> <span class="token operator">+</span> <span class="token variable">@Table</span> <span class="token operator">+</span> <span class="token string">' REBUILD'</span>
         <span class="token comment">--PRINT @cmd -- uncomment if you want to see commands</span>
         <span class="token keyword">EXEC</span> <span class="token punctuation">(</span><span class="token variable">@cmd</span><span class="token punctuation">)</span>
      <span class="token keyword">END</span> TRY
      <span class="token keyword">BEGIN</span> CATCH
         <span class="token keyword">PRINT</span> <span class="token string">'---'</span>
         <span class="token keyword">PRINT</span> <span class="token variable">@cmd</span>
         <span class="token keyword">PRINT</span> ERROR_MESSAGE<span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">PRINT</span> <span class="token string">'---'</span>
      <span class="token keyword">END</span> CATCH

      <span class="token keyword">FETCH</span> <span class="token keyword">NEXT</span> <span class="token keyword">FROM</span> TableCursor <span class="token keyword">INTO</span> <span class="token variable">@Table</span>
   <span class="token keyword">END</span>

   <span class="token keyword">CLOSE</span> TableCursor
   <span class="token keyword">DEALLOCATE</span> TableCursor

   <span class="token keyword">FETCH</span> <span class="token keyword">NEXT</span> <span class="token keyword">FROM</span> DatabaseCursor <span class="token keyword">INTO</span> <span class="token variable">@Database</span>
<span class="token keyword">END</span>
<span class="token keyword">CLOSE</span> DatabaseCursor
<span class="token keyword">DEALLOCATE</span> DatabaseCursor
</code></pre></div></div><p></p><p></p>