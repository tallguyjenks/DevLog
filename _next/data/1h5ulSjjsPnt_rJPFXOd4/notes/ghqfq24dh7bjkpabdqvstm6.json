{"pageProps":{"note":{"id":"ghqfq24dh7bjkpabdqvstm6","title":"Configuration","desc":"","updated":1652072375716,"created":1643183994393,"custom":{},"fname":"p.doing.homelab.services.proxmox.configuration","type":"note","vault":{"fsPath":"DevLog"},"contentHash":"b5cf2994dfd883df1fb4491551fa12bb","links":[{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"terms.iommu","alias":"terms.iommu","position":{"start":{"line":18,"column":8,"offset":451},"end":{"line":18,"column":23,"offset":466},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"terms.iommu"}},{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"terms.vlan","alias":"terms.vlan","position":{"start":{"line":43,"column":160,"offset":1280},"end":{"line":43,"column":174,"offset":1294},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"terms.vlan"}},{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"n.ieee-802.3ad","alias":"n.ieee-802.3ad","position":{"start":{"line":50,"column":11,"offset":1603},"end":{"line":50,"column":29,"offset":1621},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"n.ieee-802.3ad"}},{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"n.protocol.lacp","alias":"n.protocol.lacp","position":{"start":{"line":50,"column":39,"offset":1631},"end":{"line":50,"column":58,"offset":1650},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"n.protocol.lacp"}},{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"n.protocol.lacp","alias":"n.protocol.lacp","position":{"start":{"line":52,"column":60,"offset":1725},"end":{"line":52,"column":79,"offset":1744},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"n.protocol.lacp"}},{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"n.protocol.lacp","alias":"n.protocol.lacp","position":{"start":{"line":62,"column":61,"offset":2050},"end":{"line":62,"column":80,"offset":2069},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"n.protocol.lacp"}},{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"terms.nfs","alias":"terms.nfs","position":{"start":{"line":67,"column":25,"offset":2154},"end":{"line":67,"column":38,"offset":2167},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"terms.nfs"}},{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"p.doing.homelab.servers.fafnir","alias":"p.doing.homelab.servers.fafnir","position":{"start":{"line":67,"column":62,"offset":2191},"end":{"line":67,"column":96,"offset":2225},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"p.doing.homelab.servers.fafnir"}},{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"p.doing.homelab.servers.fafnir","alias":"p.doing.homelab.servers.fafnir","position":{"start":{"line":70,"column":36,"offset":2389},"end":{"line":70,"column":70,"offset":2423},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"p.doing.homelab.servers.fafnir"}},{"type":"wiki","from":{"fname":"p.doing.homelab.services.proxmox.configuration","id":"ghqfq24dh7bjkpabdqvstm6","vaultName":"DevLog"},"value":"n.port.5021","alias":"n.port.5021","position":{"start":{"line":181,"column":31,"offset":5043},"end":{"line":181,"column":46,"offset":5058},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"n.port.5021"}},{"from":{"fname":"p.doing.homelab.services.proxmox.setup","vaultName":"DevLog"},"type":"backlink","position":{"start":{"line":29,"column":4,"offset":1466},"end":{"line":29,"column":54,"offset":1516},"indent":[]},"value":"p.doing.homelab.services.proxmox.configuration","alias":"p.doing.homelab.services.proxmox.configuration"}],"anchors":{"updates-repository":{"type":"header","text":"Updates Repository","value":"updates-repository","line":8,"column":0,"depth":2},"enable-iommu":{"type":"header","text":"Enable IOMMU","value":"enable-iommu","line":20,"column":0,"depth":2},"make-proxmox-vlan-aware":{"type":"header","text":"Make Proxmox VLAN aware","value":"make-proxmox-vlan-aware","line":42,"column":0,"depth":2},"setup-linux-bridge-for-virtual-machines-separate-from-management-layer":{"type":"header","text":"Setup Linux Bridge for Virtual Machines Separate from management Layer","value":"setup-linux-bridge-for-virtual-machines-separate-from-management-layer","line":51,"column":0,"depth":2},"make-network-bridge-for-virtual-machines":{"type":"header","text":"Make Network Bridge for Virtual Machines","value":"make-network-bridge-for-virtual-machines","line":60,"column":0,"depth":3},"setup-nfs-for-backups":{"type":"header","text":"Setup NFS for backups","value":"setup-nfs-for-backups","line":71,"column":0,"depth":2},"schedule-backups":{"type":"header","text":"Schedule Backups","value":"schedule-backups","line":79,"column":0,"depth":3},"download-windows-virtio-drivers":{"type":"header","text":"Download Windows VirtIO drivers","value":"download-windows-virtio-drivers","line":91,"column":0,"depth":2},"configure-email-notifications":{"type":"header","text":"Configure Email notifications","value":"configure-email-notifications","line":97,"column":0,"depth":2},"setup-port-forwarding-for-rdp-to-windows-vms-and-make-vms-visible-on-the-internal-network":{"type":"header","text":"Setup port forwarding for RDP to windows VM's and make VM's visible on the internal network:","value":"setup-port-forwarding-for-rdp-to-windows-vms-and-make-vms-visible-on-the-internal-network","line":151,"column":0,"depth":2},"setup-iperf3-on-the-server":{"type":"header","text":"Setup iperf3 on the server","value":"setup-iperf3-on-the-server","line":173,"column":0,"depth":2}},"children":[],"parent":"scila6vssybq401kzsq1d5b","data":{}},"body":"<h1 id=\"configuration\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#configuration\"></a>Configuration</h1>\n<h2 id=\"updates-repository\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#updates-repository\"></a>Updates Repository</h2>\n<p>For regular updates and to avoid errors set the updates repository from the enterprise proxmox repo (subscription required) to the <code>pve-no-subscription</code> repo.</p>\n<p><img src=\"/DevLog/assets/images/2022-01-25-23-37-43.png\" alt=\"repos\"></p>\n<ol start=\"0\">\n<li><code>pve node > updates > repositories</code></li>\n<li>disable the enterprise repo</li>\n<li><code>[Add]</code></li>\n<li><code>pve-no-subscription</code></li>\n<li>run <code>apt-get update; apt dist-upgrade; reboot</code></li>\n</ol>\n<h2 id=\"enable-iommu\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#enable-iommu\"></a>Enable IOMMU</h2>\n<!-- markdownlint-disable MD031-->\n<p>Enable <a href=\"/DevLog/notes/0xbcevuqumdxife2dxgb30y\">iommu</a> so VM's can access hardware not made for virtualization (GPU's etc.)</p>\n<ol>\n<li>you can do this but updating the <code>/etc/default/grub</code> file\n<ul>\n<li>change <code>GRUB_CMDLINE_LINUX_ DEFAULT=\"quiet\"</code></li>\n<li>to: <code>GRUB_CMDLINE LINUX DEFAULT=\"quiet intel iommu=on\"</code></li>\n</ul>\n</li>\n<li>Then run <code>update-grub</code></li>\n<li>Then edit <code>/etc/modules</code> Add these 4 lines to it:</li>\n<li>\n<pre class=\"language-txt\"><code class=\"language-txt\">`vfio`\n`vfio_iommu_typel`\n`vfio_pci`\n`vfio_virqfd`\n</code></pre>\n</li>\n<li>Then run <code>update-initramfs -u -k all</code></li>\n<li>reboot</li>\n</ol>\n<!-- markdownlint-enable MD031-->\n<h2 id=\"make-proxmox-vlan-aware\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#make-proxmox-vlan-aware\"></a>Make Proxmox VLAN aware</h2>\n<ol>\n<li>go to <code>pve node > System > Network</code></li>\n<li>\"Edit\" your Linux bridge</li>\n<li>check the box for <code>VLAN aware:</code></li>\n<li>Click <code>Apply Configuration</code></li>\n</ol>\n<p>This will update <code>/etc/network/interfaces</code> with new settings and where it says <code>bridge-vids</code> you can change the default <code>2-4094</code> to be a single number for the <a href=\"/DevLog/notes/v9s04fmtizuk86nxjpv6354\">VLAN</a> of the server, or do that for individual virtual machines</p>\n<h2 id=\"setup-linux-bridge-for-virtual-machines-separate-from-management-layer\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#setup-linux-bridge-for-virtual-machines-separate-from-management-layer\"></a>Setup Linux Bridge for Virtual Machines Separate from management Layer</h2>\n<ol>\n<li><code>pve node > System > Network > Create > Linux Bond</code></li>\n<li><code>bond0</code></li>\n<li>List all the bridge ports in a space separated list except the 1 used for the management layer</li>\n<li>choose <a href=\"/DevLog/notes/051ngzwl2msbgfmws2hj4eq\">3ad</a> mode for <a href=\"/DevLog/notes/lgl3co3ibveuv4ejvn2yso6\">LACP</a></li>\n<li>Add Comment</li>\n<li>after finished creating modify switch side settings for <a href=\"/DevLog/notes/lgl3co3ibveuv4ejvn2yso6\">LACP</a> for those ports</li>\n</ol>\n<h3 id=\"make-network-bridge-for-virtual-machines\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#make-network-bridge-for-virtual-machines\"></a>Make Network Bridge for Virtual Machines</h3>\n<ul>\n<li><a href=\"https://youtu.be/qTbeHpdHcqs\">https://youtu.be/qTbeHpdHcqs</a></li>\n</ul>\n<ol>\n<li><code>pve node > System > Network > Create > Linux Bridge</code></li>\n<li><code>vmbr1</code> is fine</li>\n<li>Give it a IPV4 address like <code>10.10.10.0/24</code></li>\n<li>make it <code>VLAN aware:</code></li>\n<li>List all the bridge ports in a space separated list (the <a href=\"/DevLog/notes/lgl3co3ibveuv4ejvn2yso6\">LACP</a> <code>bond0</code> you made)</li>\n<li>Add Comment</li>\n</ol>\n<h2 id=\"setup-nfs-for-backups\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#setup-nfs-for-backups\"></a>Setup NFS for backups</h2>\n<ol start=\"0\">\n<li>You need to have the <a href=\"/DevLog/notes/q4aac4wbg964ofeb5d6ytv6\">Network File System</a> share already setup so <a href=\"/DevLog/notes/82umkyemhjtdlkjgew0a2km\">Fafnir</a> needs to already be setup and mounted to the proxmox instance?</li>\n<li><code>Datacenter node > storage > add > nfs</code></li>\n<li><code>ID</code> ==> \"Backups\"</li>\n<li>Server IPV4 address (address to <a href=\"/DevLog/notes/82umkyemhjtdlkjgew0a2km\">Fafnir</a>?)</li>\n<li>Export <code>/mnt/storage &#x3C;++></code></li>\n</ol>\n<h3 id=\"schedule-backups\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#schedule-backups\"></a>Schedule Backups</h3>\n<ol>\n<li><code>Datacenter node > backup > add</code></li>\n<li>Select Node to backup</li>\n<li>Select storage share to send backups to</li>\n<li>Schedule Backups</li>\n<li>Email notification Settings</li>\n<li>Compression level (ZSTD)</li>\n<li>mode == snapshot</li>\n<li>test it\n<ol>\n<li>make a backup immediately</li>\n</ol>\n</li>\n</ol>\n<h2 id=\"download-windows-virtio-drivers\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#download-windows-virtio-drivers\"></a>Download Windows VirtIO drivers</h2>\n<ol>\n<li>Go To <a href=\"https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers\">This page</a></li>\n<li>Click the link under <code>Installation</code> for downloading latest stable release</li>\n<li>upload iso to proxmox iso's in <code>local > ISO images > Upload</code></li>\n</ol>\n<h2 id=\"configure-email-notifications\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#configure-email-notifications\"></a>Configure Email notifications</h2>\n<p>Change <code>/etc/postfix/main.cf</code> to include/change these lines:</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">relayhost = [smtp.gmail.com]:587\nsmtp_use_tls = yes\nsmtp_sasl_auth_enable = yes\nsmtp_sasl_security_options = noanonymous\nsmtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd\nsmtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt\n\n#mydestination = $myhostname, localhost.$mydomain, localhost\n</code></pre>\n<p>Be sure there are no dupes as the <code>main.cf</code> may have <code>smtp_sasl_security_options = {}</code> , and <code>relayhost = {}</code>. Just delete or comment those lines.</p>\n<p>Create an <code>/etc/postfix/sasl_passwd</code> file with:</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">[smtp.gmail.com]:587    testmehere@gmail.com:PASSWD\n</code></pre>\n<p>run</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">chmod</span> <span class=\"token number\">600</span> /etc/postfix/sasl_passwd\npostmap /etc/postfix/sasl_passwd\n</code></pre>\n<p>install for passwd support:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> libsasl2-modules\n</code></pre>\n<p>Restart service:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">systemctl restart postfix.service\n</code></pre>\n<p>Test:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Test mail from postfix\"</span> <span class=\"token operator\">|</span> mail -s <span class=\"token string\">\"Test Postfix\"</span> test@test.com\n</code></pre>\n<p>Test from PVE:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"test\"</span> <span class=\"token operator\">|</span> /usr/bin/pvemailforward\n</code></pre>\n<h2 id=\"setup-port-forwarding-for-rdp-to-windows-vms-and-make-vms-visible-on-the-internal-network\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#setup-port-forwarding-for-rdp-to-windows-vms-and-make-vms-visible-on-the-internal-network\"></a>Setup port forwarding for RDP to windows VM's and make VM's visible on the internal network:</h2>\n<ol>\n<li>Start a shell from the web console</li>\n<li>edit <code>/etc/network/interfaces</code></li>\n<li>make it look like:</li>\n</ol>\n<pre class=\"language-bash\"><code class=\"language-bash\">auto vmbr1\niface vmbr1 inet static\n        address <span class=\"token number\">10.1</span>.10.0/24\n        bridge-ports bond0\n        bridge-stp off\n        bridge-fd <span class=\"token number\">0</span>\n        bridge-vlan-aware <span class=\"token function\">yes</span>\n        bridge-vids <span class=\"token number\">20</span>\n        post-up <span class=\"token builtin class-name\">echo</span> <span class=\"token number\">1</span> <span class=\"token operator\">></span> /proc/sys/net/ipv4/ip_forward\n        post-up iptables -t nat -A POSTROUTING -s <span class=\"token string\">'192.168.0.0/24'</span> -o vmbr0 -j MASQUERADE\n        post-down iptables -t nat -D POSTROUTING -s <span class=\"token string\">'192.168.0.0/24'</span> -o vmbr0 -j MASQUERADE    \n        iptables -t nat -A PREROUTING -i bond0 -p tcp --dport <span class=\"token number\">13389</span> -j DNAT --to <span class=\"token number\">192.168</span>.3.15:3389\n<span class=\"token comment\">#VM Net</span>\n</code></pre>\n<h2 id=\"setup-iperf3-on-the-server\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#setup-iperf3-on-the-server\"></a>Setup iperf3 on the server</h2>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> iperf3\n</code></pre>\n<p>In the <code>~/.profile</code> file, add this line:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">iperf3 -s <span class=\"token operator\">&#x26;</span>\n</code></pre>\n<p>this will make it so upon server startup iperf3 will be run as an independant process that can can gather data from.</p>\n<p>By default it listens on port <a href=\"/DevLog/notes/wk5g6n5tw8vwawhgm2laj88\">5021</a></p>\n<hr>\n<strong>Backlinks</strong>\n<ul>\n<li><a href=\"/DevLog/notes/p4mog8mu5oi3u7tg97iwjb4\">Setup (DevLog)</a></li>\n</ul>","noteIndex":{"id":"root","title":"root","desc":"","updated":1641013093667,"created":1595961348801,"stub":false,"custom":{"stub":false,"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":"DevLog"},"contentHash":"b0b26527a2962dbb8bd5fb9a53ad702f","links":[],"anchors":{},"children":["rzqe5mjn3q2zfscw1roxr20","Bl9NeJmftBQJyJA3X4a6u","inm1S24v2GcN3Quf7gzDb","fmx7cfcdzale0ezna61yq5z","q6tr8q7gahfijix2ktlhcu3","yah6spesmpstech2ue2k3lq","6pxwlugphnw6vm4t8kn0j5p","i17wi8y2hgivywe08h6q6it","1st35wikvph2aew8aana21u","mijr0wvj3qz0mt9pv9xo1jv","qaf8v120h0ffvbowysjxw50","sh4851li2rsrhx47wwsirgv","fwqjigvqyfxiyl3pbpjvgdw","pxdvvln974xhe8w0alh0hoy","n6yddb1smrac5ll3l1y6wbd","g5dllyqoqkenoiz3opalzu6","kbwt8ucy0yh6bo8fl0kv9iw","beykavbe22agsufmm03hu0c","2uvuqa3c15o5r4j7sqadqvr","yr6gzhx0bhzyec6f52y66vf","4no90tcdswtuwmjm0bxnetx"],"parent":null,"data":{},"body":"\nThe hyperfixated rabbit hole diving knowledge base that is my brain looking at technology.\n"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2,"vaultSelectionModeOnCreate":"smart"}},"randomNote":{},"insertNote":{"initialValue":"templates"},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{},"templateHierarchy":"template"},"workspace":{"vaults":[{"fsPath":"sterkere","visibility":"private"},{"fsPath":"Norsk","visibility":"private"},{"fsPath":"DevLog"}],"journal":{"dailyDomain":"log","name":"daily","dateFormat":"yyyy.MM.dd","addBehavior":"childOfCurrent"},"scratch":{"name":"scratch","dateFormat":"yyyy.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"todoIntegration":true,"name":"task","dateFormat":"yyyy.MM.dd","addBehavior":"asOwnDomain","statusSymbols":{"":" ","wip":"wip","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":true,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800,"dendronVersion":"0.95.1","enableFullHierarchyNoteTitle":false,"enableHandlebarTemplates":false,"templateHierarchy":"template","enableSmartRefs":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false,"enableFrontmatterTags":true,"enableHashesForFMTags":false},"publishing":{"theme":"custom","enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"assetsPrefix":"/DevLog","copyAssets":true,"siteHierarchies":["root"],"enableSiteLastModified":true,"siteRootDir":"docs","siteUrl":"https://{GITHUB_USERNAME}.github.io","enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"duplicateNoteBehavior":{"action":"useVault","payload":["DevLog"]},"writeStubs":false,"seo":{"title":"Dendron","description":"Personal knowledge space"},"github":{"enableEditLink":true,"editLinkText":"Edit this page on GitHub","editBranch":"master","editViewMode":"tree"},"enablePrettyLinks":true,"enableTaskNotes":true,"siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true}