{"pageProps":{"note":{"id":"mblohozhxqtz105fu7s5xhz","title":"Stored Proc","desc":"","updated":1643273607190,"created":1643273591180,"custom":{},"fname":"s.q.postgres.stored-proc","type":"note","vault":{"fsPath":"DevLog"},"contentHash":"946b96824ff1b17d188cecce6ec554d9","links":[],"anchors":{},"children":[],"parent":"joyevz9532y0sejj98qasb7","data":{}},"body":"<h1 id=\"stored-proc\"><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#stored-proc\"></a>Stored Proc</h1>\n<pre class=\"language-sql\"><code class=\"language-sql\">\n<span class=\"token keyword\">CREATE</span> <span class=\"token operator\">OR</span> <span class=\"token keyword\">REPLACE</span> <span class=\"token keyword\">FUNCTION</span> rpt<span class=\"token punctuation\">.</span><span class=\"token string\">\"FN_Nuke_From_Orbit\"</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">RETURNS</span> void <span class=\"token keyword\">LANGUAGE</span> <span class=\"token string\">'plpgsql'</span> <span class=\"token keyword\">AS</span> $$\n<span class=\"token keyword\">BEGIN</span>\n    <span class=\"token keyword\">TRUNCATE</span> <span class=\"token keyword\">TABLE</span> rpt<span class=\"token punctuation\">.</span>report_data<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">TRUNCATE</span> <span class=\"token keyword\">TABLE</span> rpt<span class=\"token punctuation\">.</span>report_data_clean<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">TRUNCATE</span> <span class=\"token keyword\">TABLE</span> rpt<span class=\"token punctuation\">.</span>location_trended<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">TRUNCATE</span> <span class=\"token keyword\">TABLE</span> rpt<span class=\"token punctuation\">.</span>location_top<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n$$<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">FUNCTION</span> rpt<span class=\"token punctuation\">.</span><span class=\"token string\">\"FN_Nuke_From_Orbit\"</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> OWNER <span class=\"token keyword\">TO</span> postgres<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">FUNCTION</span> rpt<span class=\"token punctuation\">.</span><span class=\"token string\">\"FN_Nuke_From_Orbit\"</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">IS</span> <span class=\"token string\">'Wipe all data in the rot schema from the Face of the earth'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token operator\">OR</span> <span class=\"token keyword\">REPLACE</span> <span class=\"token keyword\">PROCEDURE</span> rpt<span class=\"token punctuation\">.</span><span class=\"token string\">\"USP_Refresh\"</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">LANGUAGE</span> <span class=\"token string\">'plpgsql'</span> <span class=\"token keyword\">AS</span> $$\n<span class=\"token keyword\">BEGIN</span>\n    <span class=\"token comment\">/*********************************************************\n    USAGE:\n        This stored procedure can be run at any interval desired.\n        Since this performs a full truncate and load of the entire\n            rpt schema and all table data this will be expensive\n            in resources.\n        Recommendation is, depending on geographic factors of\n            store locations affecting end of day accounting totals,\n            to run the stored procedure in the off hours such as \n            at midnight or directly after C.O.B. so the day's\n            results are posted immediately after the conclusion\n            of that day's business.\n    *********************************************************/</span>\n    <span class=\"token comment\">/*********************************************************\n    Wipe The entire structure of the rpt schema for a clean\n    full rebuild via truncate and load ETL\n    *********************************************************/</span>\n    PERFORM rpt<span class=\"token punctuation\">.</span><span class=\"token string\">\"FN_Nuke_From_Orbit\"</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/*********************************************************\n    Grab all raw data and kick off the live rebuild process\n    driven by triggers.\n    *********************************************************/</span>\n    <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> rpt<span class=\"token punctuation\">.</span>report_data\n    <span class=\"token keyword\">SELECT</span> p<span class=\"token punctuation\">.</span>payment_date\n         <span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">.</span>address\n         <span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span>amount\n    <span class=\"token keyword\">FROM</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">.</span>payment <span class=\"token keyword\">AS</span> p\n        <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">.</span>staff <span class=\"token keyword\">AS</span> S <span class=\"token keyword\">ON</span> s<span class=\"token punctuation\">.</span>staff_id <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>staff_id\n        <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">.</span>store <span class=\"token keyword\">AS</span> st <span class=\"token keyword\">ON</span> st<span class=\"token punctuation\">.</span>store_id <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>store_id\n        <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">.</span>address <span class=\"token keyword\">AS</span> a <span class=\"token keyword\">ON</span> a<span class=\"token punctuation\">.</span>address_id <span class=\"token operator\">=</span> st<span class=\"token punctuation\">.</span>address_id<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n$$<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">PROCEDURE</span> rpt<span class=\"token punctuation\">.</span><span class=\"token string\">\"USP_Refresh\"</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">IS</span> <span class=\"token string\">'Refresh the entire reporting structure'</span><span class=\"token punctuation\">;</span>\n</code></pre>","noteIndex":{"id":"root","title":"root","desc":"","updated":1641013093667,"created":1595961348801,"stub":false,"custom":{"stub":false,"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":"DevLog"},"contentHash":"b0b26527a2962dbb8bd5fb9a53ad702f","links":[],"anchors":{},"children":["rzqe5mjn3q2zfscw1roxr20","Bl9NeJmftBQJyJA3X4a6u","inm1S24v2GcN3Quf7gzDb","fmx7cfcdzale0ezna61yq5z","q6tr8q7gahfijix2ktlhcu3","yah6spesmpstech2ue2k3lq","6pxwlugphnw6vm4t8kn0j5p","i17wi8y2hgivywe08h6q6it","1st35wikvph2aew8aana21u","mijr0wvj3qz0mt9pv9xo1jv","qaf8v120h0ffvbowysjxw50","sh4851li2rsrhx47wwsirgv","fwqjigvqyfxiyl3pbpjvgdw","pxdvvln974xhe8w0alh0hoy","n6yddb1smrac5ll3l1y6wbd","g5dllyqoqkenoiz3opalzu6","kbwt8ucy0yh6bo8fl0kv9iw","beykavbe22agsufmm03hu0c","2uvuqa3c15o5r4j7sqadqvr","yr6gzhx0bhzyec6f52y66vf","4no90tcdswtuwmjm0bxnetx"],"parent":null,"data":{},"body":"\nThe hyperfixated rabbit hole diving knowledge base that is my brain looking at technology.\n"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2,"vaultSelectionModeOnCreate":"smart"}},"randomNote":{},"insertNote":{"initialValue":"templates"},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{},"templateHierarchy":"template"},"workspace":{"vaults":[{"fsPath":"sterkere","visibility":"private"},{"fsPath":"Norsk","visibility":"private"},{"fsPath":"DevLog"}],"journal":{"dailyDomain":"log","name":"daily","dateFormat":"yyyy.MM.dd","addBehavior":"childOfCurrent"},"scratch":{"name":"scratch","dateFormat":"yyyy.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"todoIntegration":true,"name":"task","dateFormat":"yyyy.MM.dd","addBehavior":"asOwnDomain","statusSymbols":{"":" ","wip":"wip","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":true,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800,"dendronVersion":"0.95.1","enableFullHierarchyNoteTitle":false,"enableHandlebarTemplates":false,"templateHierarchy":"template","enableSmartRefs":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false,"enableFrontmatterTags":true,"enableHashesForFMTags":false},"publishing":{"theme":"custom","enableFMTitle":true,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"assetsPrefix":"/DevLog","copyAssets":true,"siteHierarchies":["root"],"enableSiteLastModified":true,"siteRootDir":"docs","siteUrl":"https://{GITHUB_USERNAME}.github.io","enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"duplicateNoteBehavior":{"action":"useVault","payload":["DevLog"]},"writeStubs":false,"seo":{"title":"Dendron","description":"Personal knowledge space"},"github":{"enableEditLink":true,"editLinkText":"Edit this page on GitHub","editBranch":"master","editViewMode":"tree"},"enablePrettyLinks":true,"enableTaskNotes":true,"siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true}